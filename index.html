<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tyre Quotation Helper</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e74c3c; /* Red for the 'red text' */
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h2 { text-align: center; color: var(--primary-color); margin-bottom: 30px; }

        /* Row Styling */
        .tyre-row {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .input-group {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr; /* Description gets more space */
            gap: 15px;
            align-items: start;
        }

        label {
            display: block;
            font-size: 0.85em;
            font-weight: bold;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box; /* Fix padding issues */
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* The Red Helper Text */
        .helper-text {
            color: var(--accent-color);
            font-size: 0.9em;
            margin-top: 5px;
            font-weight: 600;
            min-height: 1.2em; /* Prevent jumpiness */
        }

        /* Autocomplete List Styling */
        .autocomplete-wrapper {
            position: relative;
        }

        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            list-style: none;
            padding: 0;
            margin: 0;
            display: none; /* Hidden by default */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .suggestions-list li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
        }

        .suggestions-list li:hover {
            background-color: #f9f9f9;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-add {
            background-color: #3498db;
            color: white;
        }
        .btn-add:hover { background-color: #2980b9; }

        .btn-gen {
            background-color: #27ae60;
            color: white;
        }
        .btn-gen:hover { background-color: #219150; }

    </style>
</head>
<body>

<div class="container">
    <h2>Tyre Quotation Maker</h2>
    
    <div id="rows-container">
        </div>

    <div class="button-group">
        <button class="btn-add" onclick="addNewRow()">+ Add More Tyres</button>
        <button class="btn-gen" onclick="generateQuotation()">Generate Quotation</button>
    </div>
</div>

<script>
    let tyreDatabase = [];
    let rowCount = 0;

    // 1. Load the Database on Startup
    async function loadDatabase() {
        try {
            const response = await fetch('database.json');
            if (!response.ok) throw new Error("Could not load database.json");
            tyreDatabase = await response.json();
            console.log("Database loaded:", tyreDatabase.length, "items.");
            addNewRow(); // Add the first row automatically
        } catch (error) {
            alert("Error loading database.json. Make sure the file is in the same folder and you are running this on a server (or GitHub Pages).");
            console.error(error);
        }
    }

    // 2. Function to Create a New Row
    function addNewRow() {
        rowCount++;
        const container = document.getElementById('rows-container');

        // OPTIONAL: Clear the red text of the PREVIOUS row to keep it clean (as requested)
        if (rowCount > 1) {
            const prevRowId = rowCount - 1;
            const prevDescInfo = document.getElementById(`desc-info-${prevRowId}`);
            const prevCalcInfo = document.getElementById(`calc-info-${prevRowId}`);
            if (prevDescInfo) prevDescInfo.style.display = 'none';
            if (prevCalcInfo) prevCalcInfo.style.display = 'none';
        }

        const rowHtml = `
            <div class="tyre-row" id="row-${rowCount}">
                <div class="input-group">
                    
                    <div class="autocomplete-wrapper">
                        <label>Tyre Description / Variant</label>
                        <input type="text" id="search-${rowCount}" placeholder="Start typing tyre name..." autocomplete="off">
                        <ul class="suggestions-list" id="suggestions-${rowCount}"></ul>
                        <div class="helper-text" id="desc-info-${rowCount}"></div>
                        <input type="hidden" id="base-price-${rowCount}" value="0">
                        <input type="hidden" id="product-code-${rowCount}" value="">
                    </div>

                    <div>
                        <label>Markup (+/-)</label>
                        <input type="number" id="markup-${rowCount}" placeholder="0" value="0">
                        <div class="helper-text" id="calc-info-${rowCount}"></div>
                    </div>

                    <div>
                        <label>Quantity</label>
                        <input type="number" id="qty-${rowCount}" value="1" min="1">
                    </div>
                </div>
            </div>
        `;

        // Append new row
        container.insertAdjacentHTML('beforeend', rowHtml);

        // Attach Event Listeners for the new row
        setupRowEvents(rowCount);
    }

    // 3. Setup Logic for a Specific Row
    function setupRowEvents(id) {
        const searchInput = document.getElementById(`search-${id}`);
        const suggestionsBox = document.getElementById(`suggestions-${id}`);
        const markupInput = document.getElementById(`markup-${id}`);
        const descInfo = document.getElementById(`desc-info-${id}`);
        const calcInfo = document.getElementById(`calc-info-${id}`);
        const basePriceInput = document.getElementById(`base-price-${id}`);
        const productCodeInput = document.getElementById(`product-code-${id}`);

        // A. Autocomplete Logic
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            suggestionsBox.innerHTML = '';
            
            if (query.length < 2) {
                suggestionsBox.style.display = 'none';
                return;
            }

            // Filter database
            const matches = tyreDatabase.filter(item => 
                (item.product_description && item.product_description.toLowerCase().includes(query)) ||
                (item.product_code && item.product_code.toString().includes(query))
            ).slice(0, 10); // Limit to 10 suggestions

            if (matches.length > 0) {
                suggestionsBox.style.display = 'block';
                matches.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.product_description} (Code: ${item.product_code})`;
                    li.onclick = () => {
                        // User Selects a Tyre
                        searchInput.value = item.product_description;
                        basePriceInput.value = item.cmp_set || 0; // Store CMP
                        productCodeInput.value = item.product_code;
                        suggestionsBox.style.display = 'none';

                        // Show Red Info (Description) - FINAL FORMAT
                        descInfo.style.display = 'block';
                        descInfo.innerText = `${item.category} | Code: ${item.product_code} | NBP: ${item.nbp_gst_18} | Base CMP: ${item.cmp_set}`;

                        // Trigger price calculation immediately
                        updatePrice(id);
                    };
                    suggestionsBox.appendChild(li);
                });
            } else {
                suggestionsBox.style.display = 'none';
            }
        });

        // Hide suggestions if clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== searchInput) {
                suggestionsBox.style.display = 'none';
            }
        });

        // B. Markup Real-time Calculation
        markupInput.addEventListener('input', () => updatePrice(id));
    }

    // 4. Update Price Helper Function
    function updatePrice(id) {
        const basePrice = parseFloat(document.getElementById(`base-price-${id}`).value) || 0;
        const markup = parseFloat(document.getElementById(`markup-${id}`).value) || 0;
        const calcInfo = document.getElementById(`calc-info-${id}`);

        if (basePrice > 0) {
            const finalPrice = basePrice + markup;
            calcInfo.style.display = 'block';
            calcInfo.innerText = `Final: ${finalPrice.toFixed(2)}`;
        }
    }

    // 5. Placeholder for Step 4 (Generate PDF)
    function generateQuotation() {
        // Gather data
        let quotationData = [];
        for(let i = 1; i <= rowCount; i++) {
            const desc = document.getElementById(`search-${i}`).value;
            if(desc) {
                quotationData.push({
                    description: desc,
                    code: document.getElementById(`product-code-${i}`).value,
                    basePrice: document.getElementById(`base-price-${i}`).value,
                    markup: document.getElementById(`markup-${i}`).value,
                    qty: document.getElementById(`qty-${i}`).value
                });
            }
        }
        
        console.log("Data Ready for PDF:", quotationData);
        alert("Data captured! ready for PDF generation in the next step.");
    }

    // Initialize
    loadDatabase();

</script>

</body>
</html>
